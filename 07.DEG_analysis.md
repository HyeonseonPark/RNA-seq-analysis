# 차등발현 분석 및 클러스터링 스크립트 가이드

## 개요

이 스크립트는 RNA-seq 분석의 마지막 단계인 **차등발현 분석(Differential Expression Analysis)**과 **발현 패턴 클러스터링**을 수행합니다. **Trinity 패키지**의 도구들을 사용하여 TMM 정규화, edgeR 기반 통계 분석, 그리고 유의한 차등발현 유전자들의 발현 패턴 클러스터링을 차례로 실행합니다. 벼의 카드뮴 스트레스 반응 연구에서 Control과 Cadmium 처리 조건 간의 유전자 발현 차이를 통계적으로 검증하고 생물학적 의미를 해석하기 위한 최종 분석 단계입니다.

**주요 기능:**
- TMM (Trimmed Mean of M-values) 정규화
- edgeR을 이용한 차등발현 통계 분석
- 유의한 차등발현 유전자 식별 및 필터링
- 발현 패턴 기반 유전자 클러스터링
- 결과 시각화 및 리포트 생성

---

## 스크립트 코드

### 07.DEG_analysis.sh

```bash
#!/bin/bash
#This script working in Stringtie dir
#Our default input file name is genes.TPM.matrix, which was generated by step2
#if you change your matrix, you have to rename or modify input file
#this script need enviorment path about the [trinityrnaseq/util/support_scripts/]
date
echo "TMM normalization start!"
run_TMM_scale_matrix.pl --matrix genes.TPM.matrix > TMM.EXPR.matrix
date
echo "TMM normalization done!"
##differential expression analysis
date
echo 'Run_DE_analysis'
run_DE_analysis.pl --matrix genes.counts.matrix --method edgeR --samples_file samples.file
date
echo 'DE_analysis_expr done!'
#You must move to edgeR directory
cd edgeR.*dir/
analyze_diff_expr.pl --matrix ../TMM.EXPR.matrix --samples ../samples.file -C 1
echo 'Define_cluster'
define_clusters_by_cutting_tree.pl -R diffExpr.P0.001_C1.matrix.RData --Ptree 30 --lexical_column_ordering
date
echo 'Genome based RNAseq analysis complete!!!'
```

---

## 코드 상세 분석

## Part 1: TMM 정규화

### 1. TMM 정규화 실행
```bash
run_TMM_scale_matrix.pl --matrix genes.TPM.matrix > TMM.EXPR.matrix
```

**TMM (Trimmed Mean of M-values) 정규화:**
- **목적**: 샘플 간 라이브러리 크기와 조성 편향 보정
- **입력**: `genes.TPM.matrix` (StringTie에서 생성된 TPM 값들)
- **출력**: `TMM.EXPR.matrix` (정규화된 발현량 행렬)

**TMM 정규화의 장점:**
- 극값에 덜 민감 (trimming 사용)
- 대부분 유전자의 발현이 변하지 않는다고 가정
- edgeR의 기본 정규화 방법

**정규화 과정:**
1. 각 샘플 쌍 간의 M-value (log2 fold change) 계산
2. 극값 제거 (상하위 5% trimming)
3. 가중평균을 이용한 정규화 인수 계산
4. 전체 행렬에 정규화 적용

---

## Part 2: 차등발현 통계 분석

### 2. edgeR 차등발현 분석
```bash
run_DE_analysis.pl --matrix genes.counts.matrix --method edgeR --samples_file samples.file
```

**명령어 옵션 분석:**
- **`--matrix genes.counts.matrix`**: Raw count 데이터 사용 (통계 분석용)
- **`--method edgeR`**: edgeR 패키지를 사용한 통계 분석
- **`--samples_file samples.file`**: 실험 설계 정보 (Control vs Cadmium)

**edgeR 분석 과정:**
1. **Dispersion 추정**: 생물학적 변이 정도 계산
2. **Negative Binomial 모델링**: Count 데이터 특성에 맞는 통계 모델
3. **Exact test 수행**: 조건 간 차등발현 검정
4. **FDR 보정**: 다중검정 보정 (Benjamini-Hochberg)

**생성되는 디렉토리:**
```
edgeR.[timestamp].dir/
├── Cadmium_vs_Control.edgeR.DE_results
├── Cadmium_vs_Control.edgeR.count_matrix
├── MA_plot.pdf
├── volcano_plot.pdf  
└── edgeR.*.dir/
```

---

## Part 3: 차등발현 결과 분석

### 3. 유의한 유전자 필터링 및 시각화
```bash
cd edgeR.*dir/
analyze_diff_expr.pl --matrix ../TMM.EXPR.matrix --samples ../samples.file -C 1
```

**analyze_diff_expr.pl 옵션:**
- **`--matrix ../TMM.EXPR.matrix`**: 정규화된 발현량 데이터 사용
- **`--samples ../samples.file`**: 샘플 정보 파일
- **`-C 1`**: 절대 log2 fold change ≥ 1 (2배 이상 변화)

**기본 필터링 기준:**
- **P-value < 0.001**: 통계적 유의성
- **|log2FC| ≥ 1**: 생물학적 의미있는 변화 (2배 이상)
- **FDR < 0.05**: 다중검정 보정된 유의성

**생성되는 주요 파일들:**
```
diffExpr.P0.001_C1.matrix          # 필터링된 차등발현 유전자 행렬
diffExpr.P0.001_C1.matrix.log2.centered_filesample_cor_matrix.pdf  # 상관관계 히트맵
MA_n_Volcano_plots.pdf             # MA plot 및 Volcano plot
diffExpr.P0.001_C1.DE_results      # 통계 결과 상세 정보
```

---

## Part 4: 발현 패턴 클러스터링

### 4. 유전자 클러스터링
```bash
define_clusters_by_cutting_tree.pl -R diffExpr.P0.001_C1.matrix.RData --Ptree 30 --lexical_column_ordering
```

**클러스터링 옵션 분석:**
- **`-R diffExpr.P0.001_C1.matrix.RData`**: R 데이터 객체 입력
- **`--Ptree 30`**: 덴드로그램에서 상위 30% 높이에서 클러스터 분할
- **`--lexical_column_ordering`**: 샘플을 사전식 순서로 정렬

**클러스터링 방법:**
1. **계층적 클러스터링**: Ward linkage 방법 사용
2. **거리 측정**: 피어슨 상관계수 기반 거리
3. **동적 트리 절단**: 통계적으로 의미있는 클러스터 수 결정

**생성되는 결과:**
```
clusters_fixed_P_30/
├── subcluster_1_log2_medianCentered_fpkm.matrix    # 클러스터 1 유전자들
├── subcluster_2_log2_medianCentered_fpkm.matrix    # 클러스터 2 유전자들  
├── subcluster_3_log2_medianCentered_fpkm.matrix    # 클러스터 3 유전자들
├── ...
├── my_cluster_plots.pdf                            # 클러스터별 발현 패턴
└── cluster_membership.txt                          # 유전자-클러스터 매핑
```

---

## 출력 결과 분석

### 1. 차등발현 통계 결과
```bash
# DE_results 파일 구조
head Cadmium_vs_Control.edgeR.DE_results
```

**결과 파일 컬럼:**
```
gene_id         logFC    logCPM    PValue    FDR
LOC_Os01g01010  2.34     8.45      1.2e-5    0.001
LOC_Os01g01020  -1.87    6.23      3.4e-4    0.023
LOC_Os01g01030  3.12     9.78      5.6e-8    0.000
```

- **logFC**: log2 fold change (양수=up, 음수=down)
- **logCPM**: 평균 log2 counts per million
- **PValue**: 원시 p-value
- **FDR**: 다중검정 보정 후 false discovery rate

### 2. 차등발현 유전자 개수
```bash
# 전체 차등발현 유전자 수
wc -l diffExpr.P0.001_C1.DE_results

# Up-regulated 유전자 수
awk '$2 > 0' diffExpr.P0.001_C1.DE_results | wc -l

# Down-regulated 유전자 수  
awk '$2 < 0' diffExpr.P0.001_C1.DE_results | wc -l
```

### 3. 클러스터링 결과 해석
```bash
# 클러스터 수 확인
ls clusters_fixed_P_30/ | grep "subcluster_" | wc -l

# 각 클러스터의 유전자 수
for cluster in clusters_fixed_P_30/subcluster_*.matrix; do
    echo "$(basename $cluster): $(tail -n +2 $cluster | wc -l) genes"
done
```

**일반적인 클러스터 패턴:**
- **Cluster 1**: Control에서 높고 Cadmium에서 낮음 (Down-regulated)
- **Cluster 2**: Control에서 낮고 Cadmium에서 높음 (Up-regulated)  
- **Cluster 3**: 시간에 따른 변화 패턴 (시계열 데이터인 경우)

---

## 결과 시각화 및 해석

### 1. MA Plot 해석
- **X축**: 평균 발현량 (log2 CPM)
- **Y축**: log2 fold change
- **빨간 점**: 유의한 차등발현 유전자
- **파란 점**: 비유의한 유전자

### 2. Volcano Plot 해석  
- **X축**: log2 fold change
- **Y축**: -log10(p-value)
- **오른쪽 위**: 유의하게 up-regulated
- **왼쪽 위**: 유의하게 down-regulated

---

## 주의사항

1. **파일 경로**: Trinity 스크립트들의 정확한 PATH 설정 필요
2. **메모리 사용량**: 대용량 데이터 처리 시 충분한 메모리 필요
3. **통계적 검정력**: 반복 수가 적으면 검정력 저하
4. **생물학적 해석**: 통계적 유의성과 생물학적 의미는 별개
5. **다중검정**: FDR 보정의 중요성 인지
